#!/bin/bash
set -euo pipefail

echo "--------- 🟢 Start install docker -----------"
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release

# Cài Docker CE + Compose v2 (plugin)
if ! command -v docker >/dev/null 2>&1; then
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" \
    | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
  sudo apt update
  sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
fi

# Cho phép user hiện tại chạy docker (nếu chưa có nhóm)
if ! groups $USER | grep -q docker; then
  sudo usermod -aG docker $USER || true
fi

echo "--------- 🔴 Finish install docker -----------"

echo "--------- 🟢 Prepare volumes & permissions -----------"
docker volume create traefik_data >/dev/null
docker volume create n8n_data >/dev/null

# Traefik certificate store
docker run --rm -v traefik_data:/letsencrypt alpine \
  sh -c "touch /letsencrypt/acme.json && chmod 600 /letsencrypt/acme.json"

# Quyền n8n_data cho user node (UID 1000)
docker run --rm -v n8n_data:/data alpine \
  sh -c "mkdir -p /data && chown -R 1000:1000 /data && chmod -R 755 /data"
echo "--------- 🔴 Volumes ready -----------"

echo "--------- 🟢 Download docker-compose.yml -----------"
curl -fsSL https://raw.githubusercontent.com/I0gos/Auto-Setup-n8n/main/setup-dockerfile -o docker-compose.yml
echo "--------- 🔴 Compose downloaded -----------"

echo "--------- 🟢 Validate compose config -----------"
docker compose config >/dev/null
echo "--------- 🔴 Compose config OK -----------"

echo "--------- 🟢 docker compose up -d -----------"
docker compose up -d
echo "--------- 🔴 Done! -----------"

docker run --rm -v traefik_data:/letsencrypt alpine \
  sh -c "touch /letsencrypt/acme.json && chmod 600 /letsencrypt/acme.json"

# khởi động lại traefik để ACME chạy lại
docker compose restart traefik

IP=$(curl -s https://api.ipify.org || echo "<YOUR_PUBLIC_IP>")
echo "➡️  TẮT proxy (mây xám) khi cấp SSL lần đầu."
echo "➡️  Mở port trên Alibaba Security Group: TCP 80, 443 (0.0.0.0/0)."
echo "➡️  Kiểm tra logs:"
echo "    docker compose logs -f traefik"
echo "    docker compose logs -f n8n"
