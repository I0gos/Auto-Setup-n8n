#!/bin/bash
set -euo pipefail

echo "--------- ğŸŸ¢ Start install docker -----------"
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release

# CÃ i Docker CE + Compose v2 (plugin)
if ! command -v docker >/dev/null 2>&1; then
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" \
    | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
  sudo apt update
  sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
fi

# Cho phÃ©p user hiá»‡n táº¡i cháº¡y docker (náº¿u chÆ°a cÃ³ nhÃ³m)
if ! groups $USER | grep -q docker; then
  sudo usermod -aG docker $USER || true
fi

echo "--------- ğŸ”´ Finish install docker -----------"

echo "--------- ğŸŸ¢ Prepare volumes & permissions -----------"
docker volume create traefik_data >/dev/null
docker volume create n8n_data >/dev/null

# Traefik certificate store
docker run --rm -v traefik_data:/letsencrypt alpine \
  sh -c "touch /letsencrypt/acme.json && chmod 600 /letsencrypt/acme.json"

# Quyá»n n8n_data cho user node (UID 1000)
docker run --rm -v n8n_data:/data alpine \
  sh -c "mkdir -p /data && chown -R 1000:1000 /data && chmod -R 755 /data"
echo "--------- ğŸ”´ Volumes ready -----------"

echo "--------- ğŸŸ¢ Download docker-compose.yml -----------"
curl -fsSL https://raw.githubusercontent.com/I0gos/Auto-Setup-n8n/main/setup-dockerfile -o docker-compose.yml
echo "--------- ğŸ”´ Compose downloaded -----------"

echo "--------- ğŸŸ¢ Validate compose config -----------"
docker compose config >/dev/null
echo "--------- ğŸ”´ Compose config OK -----------"

echo "--------- ğŸŸ¢ docker compose up -d -----------"
docker compose up -d
echo "--------- ğŸ”´ Done! -----------"

docker run --rm -v traefik_data:/letsencrypt alpine \
  sh -c "touch /letsencrypt/acme.json && chmod 600 /letsencrypt/acme.json"

# khá»Ÿi Ä‘á»™ng láº¡i traefik Ä‘á»ƒ ACME cháº¡y láº¡i
docker compose restart traefik

IP=$(curl -s https://api.ipify.org || echo "<YOUR_PUBLIC_IP>")
echo "â¡ï¸  Táº®T proxy (mÃ¢y xÃ¡m) khi cáº¥p SSL láº§n Ä‘áº§u."
echo "â¡ï¸  Má»Ÿ port trÃªn Alibaba Security Group: TCP 80, 443 (0.0.0.0/0)."
echo "â¡ï¸  Kiá»ƒm tra logs:"
echo "    docker compose logs -f traefik"
echo "    docker compose logs -f n8n"
